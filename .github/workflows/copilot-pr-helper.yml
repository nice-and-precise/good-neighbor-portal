name: Copilot PR helper

on:
  workflow_dispatch:
    inputs:
      branch:
        description: Branch name to create or update (e.g., copilot/test)
        required: true
      title:
        description: Pull request title
        required: true
      body:
        description: Pull request body/description
        required: false

jobs:
  branch_and_pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          # Keep credentials so git fetch/push can authenticate (uses GITHUB_TOKEN by default)
          persist-credentials: true

      - name: Configure git identity
        run: |
          git config user.name "copilot-automation"
          git config user.email "copilot-automation@example.com"

      - name: Create or switch branch from default base and add an empty commit
        run: |
          set -e
          BRANCH="${{ github.event.inputs.branch }}"
          BASE="${{ github.event.repository.default_branch }}"
          if [ -z "$BASE" ]; then BASE="main"; fi
          echo "Using branch: $BRANCH"
          echo "Basing branch on $BASE"
          git fetch --prune origin "$BASE"
          git checkout -B "$BRANCH" "origin/$BASE"
          git commit --allow-empty -m "chore: copilot automated commit"

      - name: Push branch (use COPILOT_BOT_TOKEN, fallback to GITHUB_TOKEN)
        run: |
          set -e
          REPO="${{ github.repository }}"
          BRANCH="${{ github.event.inputs.branch }}"
          TOKEN="${{ secrets.COPILOT_BOT_TOKEN }}"
          if [ -z "$TOKEN" ]; then TOKEN="${{ secrets.GITHUB_TOKEN }}"; fi
          echo "Pushing to $REPO on branch $BRANCH"
          git push "https://x-access-token:${TOKEN}@github.com/${REPO}.git" HEAD:"$BRANCH"

      - name: Open pull request
        run: |
          set -e
          BASE="${{ github.event.repository.default_branch }}"
          if [ -z "$BASE" ]; then BASE="main"; fi
          echo "Opening PR against base: $BASE"
          GH_TOKEN="${{ secrets.COPILOT_BOT_TOKEN }}"
          if [ -z "$GH_TOKEN" ]; then GH_TOKEN="${{ secrets.GITHUB_TOKEN }}"; fi
          DATA=$(jq -n --arg title "${{ github.event.inputs.title }}" \
                       --arg head  "${{ github.event.inputs.branch }}" \
                       --arg base  "$BASE" \
                       --arg body  "${{ github.event.inputs.body }}" \
                       '{title: $title, head: $head, base: $base, body: $body}')
          curl -sS -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Accept: application/vnd.github+json" \
            -d "$DATA" \
            "https://api.github.com/repos/${{ github.repository }}/pulls" | jq '{number, html_url, state, title}'