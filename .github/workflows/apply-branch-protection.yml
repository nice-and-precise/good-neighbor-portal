name: Apply Branch Protection
'on':
  # Run once when this workflow file is added/changed
  push:
    paths:
      - .github/workflows/apply-branch-protection.yml
  # Allow manual runs anytime
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to protect"
        required: false
        default: "main"
      required_checks:
        description: "Comma-separated list of required status check names (overrides auto-detect)"
        required: false
        default: ""

permissions:
  contents: read
  actions: read

jobs:
  protect:
    name: Protect branch
    runs-on: ubuntu-latest
    env:
      GH_API: https://api.github.com
    steps:
      - name: Load admin token
        env:
          TOKEN: ${{ secrets.REPO_ADMIN_TOKEN }}
        shell: bash
        run: |
          if [ -z "${TOKEN:-}" ]; then
            echo "REPO_ADMIN_TOKEN is not set. Add it under Settings > Secrets and variables > Actions." >&2
            exit 1
          fi
          echo "::add-mask::${TOKEN}"
          echo "ADMIN_TOKEN=${TOKEN}" >> "$GITHUB_ENV"

      - name: Derive OWNER/REPO and target branch
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY##*/}"
          BRANCH_IN="${{ github.event.inputs.branch }}"
          if [ -n "$BRANCH_IN" ]; then
            BRANCH="$BRANCH_IN"
          else
            # Try to infer from ref; fallback to repo default branch
            BRANCH="${GITHUB_REF_NAME:-}"
            if [ -z "$BRANCH" ]; then
              BRANCH=$(curl -fsSL -H "Authorization: Bearer $ADMIN_TOKEN" -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" \
                "$GH_API/repos/$OWNER/$REPO" | jq -r '.default_branch')
            fi
          fi
          echo "owner=$OWNER" >> "$GITHUB_OUTPUT"
          echo "repo=$REPO" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "Using $OWNER/$REPO@$BRANCH"

      - name: Validate token has admin access to repo
        shell: bash
        run: |
          set -euo pipefail
          OWNER="${{ steps.meta.outputs.owner }}"
          REPO="${{ steps.meta.outputs.repo }}"
          RESP=$(curl -fsSL -H "Authorization: Bearer $ADMIN_TOKEN" -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" \
            "$GH_API/repos/$OWNER/$REPO")
          ADMIN=$(echo "$RESP" | jq -r '.permissions.admin // false')
          ROLE=$(echo "$RESP" | jq -r '.role_name // "unknown"')
          if [ "$ADMIN" != "true" ]; then
            echo "This token does not have admin permission on $OWNER/$REPO (role=$ROLE)." >&2
            echo "Ensure the PAT is classic with 'repo' scope or fine-grained with Repository permissions: Administration=Read and write, and it has access to this repository (and SSO is authorized if org-enforced)." >&2
            exit 1
          fi
          echo "Token has admin permission on $OWNER/$REPO (role=$ROLE)."

      - name: Get latest commit on branch
        id: head
        shell: bash
        run: |
          set -euo pipefail
          OWNER="${{ steps.meta.outputs.owner }}"
          REPO="${{ steps.meta.outputs.repo }}"
          BRANCH="${{ steps.meta.outputs.branch }}"
          SHA=$(curl -fsSL -H "Authorization: Bearer $ADMIN_TOKEN" -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" \
            "$GH_API/repos/$OWNER/$REPO/commits?sha=$BRANCH&per_page=1" | jq -r '.[0].sha')
          if [ "$SHA" = "null" ] || [ -z "$SHA" ]; then
            echo "Failed to resolve HEAD sha for $BRANCH" >&2
            exit 1
          fi
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          echo "HEAD sha: $SHA"

      - name: Discover check runs to require (poll up to 5 minutes)
        id: checks
        shell: bash
        run: |
          set -euo pipefail
          OWNER="${{ steps.meta.outputs.owner }}"
          REPO="${{ steps.meta.outputs.repo }}"
          SHA="${{ steps.head.outputs.sha }}"
          # If user provided explicit required_checks, use them and skip auto-detect
          INPUT_CTX='${{ github.event.inputs.required_checks }}'
          if [ -n "$INPUT_CTX" ]; then
            # Split by comma and trim spaces
            mapfile -t arr < <(echo "$INPUT_CTX" | tr ',' '\n' | sed 's/^ *//; s/ *$//' | sed '/^$/d')
            printf 'Using explicit required checks: %s\n' "${arr[*]}"
            printf '%s\n' "${arr[@]}" | jq -R . | jq -s . > /tmp/contexts.json
            echo "contexts_file=/tmp/contexts.json" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          REQUIRED_NAMES_JSON="[]"
          for i in {1..30}; do
            RESP=$(curl -fsSL -H "Authorization: Bearer $ADMIN_TOKEN" -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" \
              "$GH_API/repos/$OWNER/$REPO/commits/$SHA/check-runs?per_page=100")
            # Collect GitHub Actions check run names, excluding this workflow's job if any
            NAMES=$(echo "$RESP" | jq -c '[.check_runs[]
              | select(.app.slug=="github-actions")
              | select((.name|test("Apply Branch Protection")|not) and (.name != "Protect branch"))
              | .name] | unique') || NAMES="[]"
            COUNT=$(echo "$NAMES" | jq 'length')
            echo "Detected $COUNT GitHub Actions check run name(s): $NAMES"
            if [ "$COUNT" -gt 0 ]; then
              REQUIRED_NAMES_JSON="$NAMES"
              break
            fi
            sleep 10
          done
          echo "$REQUIRED_NAMES_JSON" > /tmp/contexts.json
          echo "contexts_file=/tmp/contexts.json" >> "$GITHUB_OUTPUT"

      - name: Apply branch protection
        id: protect
        shell: bash
        run: |
          set -euo pipefail
          OWNER="${{ steps.meta.outputs.owner }}"
          REPO="${{ steps.meta.outputs.repo }}"
          BRANCH="${{ steps.meta.outputs.branch }}"
          CONTEXTS_FILE='${{ steps.checks.outputs.contexts_file }}'
          if [ -z "$CONTEXTS_FILE" ] || [ ! -s "$CONTEXTS_FILE" ]; then
            echo '[]' > /tmp/contexts.json
            CONTEXTS_FILE=/tmp/contexts.json
          fi
          echo "Using contexts file: $CONTEXTS_FILE"
          BODY=$(jq -c -n --slurpfile ctx "$CONTEXTS_FILE" '{
            required_status_checks: { strict: true, contexts: $ctx[0] },
            enforce_admins: true,
            required_pull_request_reviews: {
              required_approving_review_count: 1,
              dismiss_stale_reviews: true,
              require_code_owner_reviews: true
            },
            restrictions: null,
            required_linear_history: true,
            allow_force_pushes: false,
            allow_deletions: false,
            lock_branch: false,
            required_conversation_resolution: true
          }')
          echo "Applying protection to $OWNER/$REPO@$BRANCH"
          HTTP_CODE=$(curl -sS -o /tmp/protect_resp.json -w '%{http_code}' -X PUT \
            -H "Authorization: Bearer $ADMIN_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            "$GH_API/repos/$OWNER/$REPO/branches/$BRANCH/protection" \
            --data "$BODY")
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "Failed to apply protection (HTTP $HTTP_CODE). Response body:" >&2
            cat /tmp/protect_resp.json >&2
            exit 1
          fi
          echo "applied=true" >> "$GITHUB_OUTPUT"

      - name: Fetch and summarize protection
        if: steps.protect.outputs.applied == 'true'
        shell: bash
        run: |
          set -euo pipefail
          OWNER="${{ steps.meta.outputs.owner }}"
          REPO="${{ steps.meta.outputs.repo }}"
          BRANCH="${{ steps.meta.outputs.branch }}"
          PROT=$(curl -fsSL -H "Authorization: Bearer $ADMIN_TOKEN" -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" \
            "$GH_API/repos/$OWNER/$REPO/branches/$BRANCH/protection")
          echo "Protection summary:" >> $GITHUB_STEP_SUMMARY
          echo "\n\n" >> $GITHUB_STEP_SUMMARY
          echo "$PROT" | jq '{
            branch: "'"$BRANCH"'",
            enforce_admins: .enforce_admins.enabled,
            required_linear_history: .required_linear_history.enabled,
            required_conversation_resolution: .required_conversation_resolution.enabled,
            allow_force_pushes: .allow_force_pushes.enabled,
            allow_deletions: .allow_deletions.enabled,
            required_pull_request_reviews: {
              required_approving_review_count: .required_pull_request_reviews.required_approving_review_count,
              dismiss_stale_reviews: .required_pull_request_reviews.dismiss_stale_reviews,
              require_code_owner_reviews: .required_pull_request_reviews.require_code_owner_reviews
            },
            required_status_checks: .required_status_checks
          }' | tee -a $GITHUB_STEP_SUMMARY
